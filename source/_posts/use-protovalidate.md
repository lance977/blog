---
title: protovalidate使用
date: 2025-06-24 19:45:15
tags:
    - GO
    - gRPC
    - validate
categories: Go
---

# 前言
在开发HTTP应用时，我们会使用`github.com/go-playground/validator/v10`进行参数校验，使用结构体中的tag指定规则可以自动进行校验，就不用我们自己再去手动校验相应的参数。
那么在gRPC中是不是也可以自动校验，从而取代繁琐的手动参数校验，这就是本次的主题`buf.build/go/protovalidate`
# 下载Buf
```shell
brew install bufbuild/buf/buf
```
# 使用
## 目录结构
```sh
.
├── api
│   └── user
│       └── v1
│           └── user.proto
├── go.mod
└── main.go
```

## 初始化buf模块
通过以下命令，会生成`buf.yaml`文件
```shell
buf config init
```
buf.yaml

```yaml
# For details on buf.yaml configuration，visit https://buf.build/docs/configuration/v2/buf-yaml
version: v2
lint:
  use:
    - STANDARD
breaking:
  use:
    - FILE
```
## 添加模块和依赖
在`buf.yaml`文件中添加模块和需要的依赖
```yaml
# For details on buf.yaml configuration，visit https://buf.build/docs/configuration/v2/buf-yaml
version: v2
# 指定模块，至少需要一个
modules:
  - path: api
# 依赖项
deps:
  - buf.build/bufbuild/protovalidate
lint:
  use:
    - STANDARD
breaking:
  use:
    - FILE
```
### 更新依赖项
添加完依赖项后，使用buf命令更新依赖项，会生成一个`buf.lock`文件
```shell
buf dep update
```
buf.lock文件
```txt
# Generated by buf. DO NOT EDIT.
version: v2
deps:
  - name: buf.build/bufbuild/protovalidate
    commit: 9f2d3c737feb481a83375159c0733275
    digest: b5:19d3b83f7df2d284ff5935f4622d7f27e7464a93c210edb536e92a52bcc69b2a18da1312e96b5461601eba7b3764d5e90321bd62e6966870e7dbc2e4dedd98d6
```
## Lint
使用`buf lint`命令，可以做静态检查，根据输出的结果做相应的调整

## 生成
### 新建生成文件
新建文件`buf.gen.yaml`
```yaml
version: v2
inputs:
  - directory: .
plugins:
  # 远程的，生成pb.go文件(message)
  - remote: buf.build/protocolbuffers/go:v1.36.5
    out: api  # 输出目录
    opt:
      - paths=source_relative
  # 本地的，生成_grpc.pb.go文件(service)
  - local: protoc-gen-go-grpc
    out: api
    opt: paths=source_relative
```
### 生成
使用`buf generate`命令，会生成对应插件的文件，当前配置就会生成`user.pb.go`和`user_grpc.pb.go`文件
```sh
.
├── api
│   └── user
│       └── v1
│           ├── user.pb.go
│           ├── user.proto
│           └── user_grpc.pb.go
├── buf.gen.yaml
├── buf.lock
├── buf.yaml
├── go.mod
└── main.go
```
## 校验
### 编写proto文件
```protobuf
syntax = "proto3";

package user.v1;

import "buf/validate/validate.proto";

option go_package = "github.com/ff/user/user/v1";

message RegisterReq {
  string email = 1 [(buf.validate.field).string.email = true];
  string password = 2 [(buf.validate.field).cel = {
    id: "user.password"
    message: "密码长度至少需要8位"
    expression: "this.size() >= 8"
  }];
}

message RegisterResp {}

service User {
  rpc Register(RegisterReq) returns(RegisterResp);
}
```
### 重新生成
使用`buf generate`命令重新生成相应的pb文件

### 参数校验
```go
package main

import (
	"fmt"

	"buf.build/go/protovalidate"
	
	userv1 "github.com/ff/user/api/user/v1"
)

func main() {
	req := &userv1.RegisterReq{
		Email:    "abc",
		Password: "123456",
	}

	validate, err := protovalidate.New()
	if err != nil {
		panic(err)
	}
	err = validate.Validate(req)
	if err != nil {
		fmt.Println(err)
	}
}
```
运行程序会得到以下结果
```sh
validation error:
 - email: value must be a valid email address [string.email]
 - password: 密码长度至少需要8位 [user.password]
```

# Tips
在使用buf时，依赖的是远程的，所以生成是没有问题的。但是在本地IDE中，proto文件导入的`buf/validate/validate.proto`是报红的，是因为本地IDE的`protoc`找不到对应的包，所以会出现报错。
可以通过`buf export`命令，将包导出到本地，然后在IDE导入进去就行了。

## import问题

{% img [img] /img/protovalidate/import-red.png '"text"' %}

## 导出
创建文件夹`third_party`并将导出的文件输出到该文件夹下。
```shell
mkdir third_party && buf export buf.build/bufbuild/protovalidate --output third_party
```

## IDE导入

{% img [img] /img/protovalidate/ide-proto-import.png '"text"' %}

设置完成后就不会报红了
